<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chór Echo - Udostępniona Kolekcja</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Georgia', serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .access-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(10px); }
        .access-form { background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center; }
        .access-form h2 { color: #2c3e50; margin-bottom: 30px; font-size: 1.8rem; }
        .access-input { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #bdc3c7; border-radius: 25px; font-size: 16px; text-align: center; }
        .access-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .error-message { color: #e74c3c; font-size: 14px; margin-top: 10px; }
        .hidden { display: none !important; }
        .main-content { display: none; }
        header { text-align: center; margin-bottom: 40px; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h1 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: #7f8c8d; font-size: 1.2rem; font-style: italic; }
        .music-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-top: 30px; }
        .music-item { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); transition: all 0.3s ease; }
        .music-item:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .music-title { font-size: 1.3rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .music-composer { color: #7f8c8d; font-style: italic; margin-bottom: 15px; }
        .music-genre { display: inline-block; background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 15px; }
        .file-preview { width: 100%; height: 200px; background: #f8f9fa; border: 2px dashed #bdc3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 3rem; color: #95a5a6; cursor: pointer; }
        .file-image { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; cursor: pointer; }
        .audio-player { width: 100%; margin-bottom: 15px; }
        .audio-player audio { width: 100%; border-radius: 10px; }
        .download-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; text-decoration: none; padding: 10px 20px; border-radius: 20px; display: inline-block; font-weight: bold; margin-right: 10px; }
        .youtube-btn { display: inline-block; width: 32px; height: 32px; background: #FF0000; border-radius: 50%; text-decoration: none; color: white; font-weight: bold; font-size: 14px; line-height: 32px; text-align: center; margin-left: 10px; transition: all 0.3s ease; }
        .youtube-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3); }
        .filter-section { background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; margin-bottom: 30px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 16px; }
        .upload-notice { background: rgba(52,152,219,0.1); border-left: 4px solid #3498db; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
        .upload-notice h3 { color: #2c3e50; margin-bottom: 10px; }
        .upload-notice p { color: #7f8c8d; }
        .loading-indicator { text-align: center; padding: 40px; color: #3498db; }
        .error-indicator { text-align: center; padding: 60px; color: #e74c3c; }
        .error-indicator h3 { margin-bottom: 10px; }
        .error-indicator small { color: #7f8c8d; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal.hidden { display: none; }
        .modal-content { background: #fff; border-radius: 12px; max-width: 90%; width: 800px; padding: 10px; position: relative; }
        .close-btn { position: absolute; right: 15px; top: 10px; font-size: 28px; cursor: pointer; color: #fff; text-shadow: 0 0 4px #000; }
        @media (max-width: 768px) { .music-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="access-gate" id="accessGate">
        <div class="access-form">
            <h2>Dostęp do Kolekcji</h2>
            <input type="password" id="accessPassword" class="access-input" placeholder="Wprowadź hasło dostępu">
            <button onclick="checkAccess()" class="access-btn">Wejdź</button>
            <div id="accessError" class="error-message hidden"></div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="container">
            <header>
                <h1>MuzyczneNuty</h1>
                <p class="subtitle">Udostępniona kolekcja nut i nagrań</p>
            </header>

            <div class="upload-notice">
                <h3>Aby dodać utwory</h3>
                <p>Skontaktuj się z administratorem strony lub dodaj pliki bezpośrednio do folderu <code>files/</code> w repozytorium GitHub</p>
            </div>

            <div class="filter-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Szukaj utworów...">
            </div>

            <div class="music-grid" id="musicGrid">
                <div class="loading-indicator">
                    <div style="font-size: 2rem; margin-bottom: 10px;">♪</div>
                    <div>Ładowanie katalogu utworów...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="musescoreModal" class="modal hidden" onclick="if(event.target===this) closeMusescoreModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMusescoreModal()">&times;</span>
            <iframe id="musescoreFrame" width="100%" height="600" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        // Zaszyfrowany hash hasła (SHA-256) - NIE PRZECHOWUJEMY PRAWDZIWEGO HASŁA!
        const PASSWORD_HASH = '083ba93b3d5e38d5f739867a2207934a6f17eb7feefc4ba29c864bc66fb12b4f';

        const GITHUB_CONFIG = {
            username: 'AnonBOTpl',
            repository: 'muzyczne-nuty',
            branch: 'main'
        };

        let MUSIC_CATALOG = [];

        // Funkcja hashowania hasła (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkAccess() {
            const password = document.getElementById('accessPassword').value;
            const errorEl = document.getElementById('accessError');

            // Hashuj wprowadzone hasło i porównaj z zapisanym hashem
            const inputHash = await hashPassword(password);

            if (inputHash === PASSWORD_HASH) {
                const accessToken = btoa(Date.now() + '-' + Math.random());
                sessionStorage.setItem('musicAccessToken', accessToken);
                showMainContent();
                errorEl.classList.add('hidden');
            } else {
                errorEl.textContent = 'Nieprawidłowe hasło';
                errorEl.classList.remove('hidden');
                setTimeout(() => { 
                    document.getElementById('accessPassword').value = ''; 
                    errorEl.classList.add('hidden');
                }, 2000);
            }
        }

        async function loadMusicCatalog() {
            try {
                document.getElementById('musicGrid').innerHTML = `
                    <div class="loading-indicator">
                        <div style="font-size: 2rem; margin-bottom: 10px;">♪</div>
                        <div>Ładowanie katalogu utworów...</div>
                    </div>
                `;

                const response = await fetch("music.json?v=" + Date.now());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Nieprawidłowy format pliku music.json - oczekiwana tablica');
                }

                MUSIC_CATALOG = data;
                loadMusicItems();

            } catch (error) {
                console.error("Błąd wczytywania music.json:", error);

                let errorMessage = 'Nie udało się wczytać katalogu utworów.';
                let errorDetails = '';

                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Brak połączenia internetowego.';
                    errorDetails = 'Sprawdź połączenie i odśwież stronę';
                } else if (error.message.includes('HTTP 404')) {
                    errorMessage = 'Plik music.json nie został znaleziony.';
                    errorDetails = 'Sprawdź czy plik istnieje w repozytorium';
                } else if (error.message.includes('JSON')) {
                    errorMessage = 'Błąd w strukturze pliku music.json.';
                    errorDetails = 'Sprawdź składnię JSON';
                } else {
                    errorDetails = error.message;
                }

                document.getElementById('musicGrid').innerHTML = `
                    <div class="error-indicator">
                        <h3>${errorMessage}</h3>
                        <small>${errorDetails}</small>
                        <div style="margin-top: 20px;">
                            <button onclick="loadMusicCatalog()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Spróbuj ponownie
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function showMainContent() {
            document.getElementById('accessGate').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadMusicCatalog();
        }

        function loadMusicItems() {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            if (!MUSIC_CATALOG || MUSIC_CATALOG.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #7f8c8d;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">♪</div>
                        <div>Brak utworów w kolekcji</div>
                        <small>Dodaj utwory do pliku music.json</small>
                    </div>
                `;
                return;
            }

            MUSIC_CATALOG.forEach(item => {
                if (!item.title || !item.composer) {
                    console.warn('Pominięto utwór z brakującymi danymi:', item);
                    return;
                }

                const itemElement = document.createElement('div');
                itemElement.className = 'music-item';
                itemElement.dataset.title = item.title.toLowerCase();
                itemElement.dataset.composer = item.composer.toLowerCase();
                itemElement.dataset.genre = item.genre || '';

                const baseUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/${GITHUB_CONFIG.branch}/files`;
                const sheetUrl = item.sheetFile ? `${baseUrl}/sheets/${item.sheetFile}` : null;
                const audioUrl = item.audioFile ? `${baseUrl}/audio/${item.audioFile}` : null;

                let sheetContent = '<div class="file-preview">🎼</div>';
                if (sheetUrl) {
                    const fileExt = item.sheetFile.toLowerCase();
                    if (fileExt.includes('.jpg') || fileExt.includes('.png') || fileExt.includes('.jpeg')) {
                        sheetContent = `<img src="${sheetUrl}" alt="Nuty - ${item.title}" class="file-image" onclick="window.open('${sheetUrl}', '_blank')" loading="lazy">`;
                    } else {
                        sheetContent = `<div class="file-preview" onclick="window.open('${sheetUrl}', '_blank')" title="Otwórz plik PDF">📄<br><small>PDF</small></div>`;
                    }
                }

                let audioContent = '<p style="color: #7f8c8d; font-style: italic;">Brak pliku audio</p>';
                if (audioUrl) {
                    audioContent = `<audio controls preload="metadata">
                        <source src="${audioUrl}" type="audio/mpeg">
                        <source src="${audioUrl}" type="audio/wav">
                        <source src="${audioUrl}" type="audio/ogg">
                        Twoja przeglądarka nie obsługuje odtwarzania audio.
                    </audio>`;
                }

                let musescoreContent = '';
                if (item.musescoreUrl) {
                    let embedUrl = item.musescoreUrl;
                    if (!embedUrl.includes('/embed')) {
                        embedUrl = embedUrl.replace(/\/$/, '') + '/embed';
                    }
                    musescoreContent = `
                        <div style="margin-bottom:15px; text-align:center;">
                            <button onclick="openMusescoreModal('${embedUrl}')" 
                                style="padding:10px 20px; border:none; border-radius:8px; background:#3498db; color:#fff; cursor:pointer;">
                                Otwórz nuty
                            </button>
                        </div>
                    `;
                }

                const downloadButton = sheetUrl 
                    ? `<a href="${sheetUrl}" download="${item.title} - ${item.composer}" class="download-btn" title="Pobierz plik">Pobierz nuty</a>`
                    : '';

                const youtubeSearchQuery = encodeURIComponent(`${item.composer} ${item.title}`);
                const youtubeButton = `<a href="https://www.youtube.com/results?search_query=${youtubeSearchQuery}" 
                    target="_blank" class="youtube-btn" title="Szukaj w YouTube">YT</a>`;

                const safeTitle = escapeHtml(item.title);
                const safeComposer = escapeHtml(item.composer);
                const safeGenre = escapeHtml(item.genre || 'Nieokreślony');
                const safeDescription = item.description ? escapeHtml(item.description) : '';

                itemElement.innerHTML = `
                    <div class="music-title">${safeTitle}</div>
                    <div class="music-composer">${safeComposer}</div>
                    <div class="music-genre">${safeGenre}</div>
                    ${sheetContent}
                    ${musescoreContent}
                    <div class="audio-player">${audioContent}</div>
                    ${safeDescription ? `<p style="color: #666; margin-bottom: 15px; font-style: italic;">${safeDescription}</p>` : ''}
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${downloadButton}
                            ${youtubeButton}
                        </div>
                        <small style="color: #95a5a6;">${formatDate(item.createdAt)}</small>
                    </div>
                `;

                grid.appendChild(itemElement);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                return new Date(dateString).toLocaleDateString('pl-PL');
            } catch (e) {
                return dateString;
            }
        }

        function openMusescoreModal(url) {
            const modal = document.getElementById('musescoreModal');
            const frame = document.getElementById('musescoreFrame');
            frame.src = url;
            modal.classList.remove('hidden');
        }

        function closeMusescoreModal() {
            const modal = document.getElementById('musescoreModal');
            const frame = document.getElementById('musescoreFrame');
            frame.src = "";
            modal.classList.add('hidden');
        }

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.toLowerCase();

            searchTimeout = setTimeout(() => {
                const items = document.querySelectorAll('.music-item');
                items.forEach(item => {
                    const title = item.dataset.title || '';
                    const composer = item.dataset.composer || '';
                    const genre = item.dataset.genre || '';
                    const matches = title.includes(searchTerm) || 
                                  composer.includes(searchTerm) || 
                                  genre.includes(searchTerm);
                    item.style.display = matches ? 'block' : 'none';
                });
            }, 300);
        });

        document.getElementById('accessPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { 
                checkAccess(); 
            }
        });

        if (sessionStorage.getItem('musicAccessToken')) {
            showMainContent();
        }

        window.addEventListener('error', function(e) {
            console.error('Błąd aplikacji:', e.error);
        });
    </script>
</body>
</html>
